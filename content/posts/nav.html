<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigation</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background: #f5f6fa;
            --card-bg: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background: var(--background);
            padding: 20px;
        }

        html {
            scroll-behavior: smooth;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Increase container width for wider screens to support 4 cards */
        @media (min-width: 1400px) {
            .container {
                max-width: 1400px;
            }
        }

        @media (min-width: 1600px) {
            .container {
                max-width: 1600px;
            }
        }

        .search-box {
            margin: 2rem 0;
            text-align: center;
            position: relative;
        }

        #searchInput {
            width: 60%;
            padding: 12px 20px;
            border: 2px solid var(--secondary-color);
            border-radius: 25px;
            font-size: 16px;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.2);
            transform: scale(1.02);
        }

        #searchInput::placeholder {
            color: #95a5a6;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            margin-top: 5px;
        }

        .search-suggestions.show {
            display: block;
        }

        .search-suggestion {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            transition: background 0.2s ease;
        }
        .search-suggestion:last-child { border-bottom: none; }
        .search-suggestion:hover { background: #f0f8ff; }
        .search-suggestion::before { content: "üîç"; margin-right: 10px; }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }

        /* Support up to 4 cards per row when window is wide enough */
        @media (min-width: 1400px) {
            .category-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                max-width: 1400px;
            }
        }

        @media (min-width: 1600px) {
            .category-grid {
                grid-template-columns: repeat(4, 1fr);
                max-width: 1600px;
            }
        }

        .category-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 1;
            position: relative;
        }

        /* Disable transitions when card is expanded to prevent other cards from animating */
        .category-card[data-state="expanded"] {
            transition: none;
        }

        /* Temporarily disable all card transitions during collapse */
        body.disable-card-transitions .category-card {
            transition: none !important;
            transform: none !important; /* Prevent any transform during transition disable */
        }

        /* Completely freeze grid during single column collapse */
        body.disable-card-transitions .category-grid {
            transition: none !important;
        }

        body.disable-card-transitions .category-grid .category-card {
            transition: none !important;
            animation: none !important;
        }

        /* Special state for cards returning to normal position */
        .category-card[data-state="collapsed"] {
            transition: none !important; /* Ensure smooth return without affecting other cards */
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .category-title {
            color: var(--primary-color);
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            transition: color 0.3s ease, transform 0.3s ease;
        }
        
        .category-title:hover {
            transform: translateX(5px);
            color: var(--secondary-color);
        }

        .link-list {
            list-style: none;
        }

        .link-item {
            margin: 0.5rem 0;
            transition: opacity 0.3s ease, transform 0.3s ease, height 0.3s ease, margin 0.3s ease;
        }

        .link-item a {
            color: #34495e;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .link-item a:hover {
            background: #e8f4fd;
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }

        .link-item a::before {
            content: "‚ñ∂";
            color: var(--secondary-color);
            margin-right: 12px;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .link-item.hidden {
            opacity: 0;
            height: 0;
            overflow: hidden;
            margin: 0;
            transform: translateX(-20px);
        }

        .more-indicator {
            position: absolute;
            bottom: 15px;
            right: 15px;
            color: #95a5a6;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 5;
            border: none;
        }
        .more-indicator:hover {
            opacity: 1;
            color: var(--secondary-color);
            transform: scale(1.05);
        }

        /* --- Expanded Card State --- */
        .category-card[data-state="expanded"] {
            position: absolute;
            z-index: 1001;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
            width: var(--expanded-width, 400px);
            min-width: 300px;
            top: var(--card-top);
            left: var(--card-left);
        }
        .category-card[data-state="expanded"].expand-left {
            transform-origin: right center;
            left: calc(var(--card-left) - (var(--expanded-width, 400px) - var(--original-width)));
        }

        /* Perfect placeholder that maintains exact grid space */
        .category-card-placeholder {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            pointer-events: none;
            z-index: 0;
            position: relative;
            transition: none !important;
            /* Exact same styling as normal card but invisible */
        }

        /* Ensure placeholder never becomes visible or interactive */
        .category-card-placeholder * {
            pointer-events: none !important;
            opacity: 0 !important;
        }
        .category-card[data-state="expanded"] .more-indicator {
            opacity: 0;
            pointer-events: none;
        }

        /* On mobile, expanded cards should use full available width */
        @media (max-width: 768px) {
            .category-card[data-state="expanded"] {
                position: fixed !important;
                top: 10px !important;
                left: 10px !important;
                width: calc(100vw - 20px) !important;
                max-width: calc(100vw - 20px);
                height: calc(100vh - 20px);
                overflow-y: auto;
            }
            .category-card[data-state="expanded"].expand-left {
                left: 10px !important;
            }
        }

        .link-list.multi-column {
            display: flex;
            flex-direction: row;
            gap: 1.5rem; /* Reduced gap to give more space for content */
        }
        .link-column {
            flex: 0 0 280px;
            list-style: none;
            overflow: hidden;
            padding-right: 8px; /* Add right padding to prevent edge overflow */
        }
        
        /* Force single column layout on narrow screens for expanded cards */
        @media (max-width: 768px) {
            .link-list.multi-column {
                flex-direction: column;
                gap: 0;
            }
            .link-column {
                flex: none;
                width: 100%;
                padding-right: 0;
            }
        }
        
        /* Multi-column specific link styling to prevent overflow */
        .link-list.multi-column .link-item a {
            max-width: calc(280px - 40px); /* Column width minus padding, margins and buffer */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-sizing: border-box;
            margin-right: 8px; /* Extra margin to prevent edge cases */
        }
        
        .link-list.multi-column .link-item a:hover {
            /* No horizontal transform in multi-column to prevent overflow */
            transform: none;
            /* Keep text strictly constrained */
            max-width: calc(280px - 40px);
            background: #e8f4fd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
            position: relative;
            z-index: 10;
            /* Add subtle scale effect instead of translation */
            transform: scale(1.01); /* Reduced scale to be more subtle */
            transform-origin: left center;
        }
        
        /* Add a tooltip for long text in multi-column layout */
        .link-list.multi-column .link-item a[title]:hover::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 300px;
            word-break: break-word;
            white-space: normal;
            margin-top: 4px;
            opacity: 0;
            animation: fadeInTooltip 0.3s ease forwards;
        }
        
        @keyframes fadeInTooltip {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Global State when a card is expanded --- */
        body.is-card-expanded .category-card:not([data-state="expanded"]):not(.category-card-placeholder) {
            pointer-events: none;
            opacity: 0.6;
            filter: blur(2px);
            transition: none; /* Disable transitions to prevent unwanted animations */
        }
        body.is-card-expanded .category-card:not([data-state="expanded"]):not(.category-card-placeholder):hover {
            transform: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Placeholder should remain completely invisible in any state */
        body.is-card-expanded .category-card-placeholder {
            opacity: 0 !important;
            filter: none !important;
            pointer-events: none !important;
        }

        #global-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        #global-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* --- Search State --- */
        body.is-searching .category-card.hidden-by-search {
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 1rem;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .category-grid { grid-template-columns: 1fr; gap: 1rem; padding: 0.5rem; }
            #searchInput, .search-suggestions { width: 90%; }
            #searchInput:focus { width: 95%; }
            .link-list.multi-column { flex-direction: column; }
            
            /* Fix more button position on mobile */
            .more-indicator {
                right: 10px;
                bottom: 10px;
                font-size: 0.7rem;
                padding: 3px 6px;
            }
            
            /* Hide more button when card is in expanded state on mobile */
            .category-card[data-state="expanded"] .more-indicator {
                display: none;
            }
        }

        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search websites... (Ctrl+K)">
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
        </header>

        <div class="category-grid" id="categoriesContainer">
            <!-- Categories content generated dynamically by JavaScript -->
        </div>
    </div>

    <div id="global-overlay" class="hidden"></div>

    <footer>
        <p></p>
        <p>Usage tips: Ctrl+D to bookmark</p>
    </footer>

    <script>
        const siteData = [
            {
                category: "Academic Resources",
                links: [
                    { name: "Google Scholar", url: "https://scholar.google.com/schhp?hl=en&as_sdt=0,5" },
                    { name: "Web of Science", url: "https://www.webofscience.com/wos/woscc/basic-search" },
                    { name: "Scopus", url: "https://www.scopus.com/search/form.uri?display=basic" },
                    { name: "Bohrium", url: "https://www.bohrium.com/" },
                    { name: "Shanghai Library", url: "https://z.library.sh.cn/next" },
                    { name: "TUC Library", url: "https://www.tu-chemnitz.de/ub/index.html.en#" },
                    { name: "SLUB Dresden", url: "https://www.slub-dresden.de/" },
                    { name: "ResearchGate", url: "https://www.researchgate.net/" },
                    { name: "ProQuest", url: "https://www.proquest.com/?accountid=1" },
                    { name: "Science Direct", url: "https://www.sciencedirect.com/" },
                    { name: "Springer", url: "https://link.springer.com/" },
                    { name: "Wiley", url: "https://onlinelibrary.wiley.com/" },
                    { name: "Emerald", url: "https://www.emerald.com/insight/" },
                    { name: "EBSCO", url: "https://www.ebsco.com/" },
                    { name: "arxiv", url: "https://arxiv.org/" },
                    { name: "IEEE Xplore", url: "https://ieeexplore.ieee.org/Xplore/home.jsp" },
                    { name: "APS", url: "https://www.aps.org/" },
                    { name: "ACS Publications", url: "https://pubs.acs.org/" },
                    { name: "Nature", url: "https://www.nature.com/" },
                    { name: "Zenodo", url: "https://zenodo.org/" },
                    { name: "Libgen", url: "https://libgen.is" },
                    { name: "Z-library", url: "https://z-library.sk/" },
                    { name: "Sci-Hub", url: "https://sci-hub.se" },
                    { name: "SCMOR Navigation", url: "https://ac.scmor.com/" }
                ]
            },
            {
                category: "TUC",
                links: [
                    { name: "SB-Service", url: "https://campus.tu-chemnitz.de/qisserver/pages/cs/sys/portal/hisinoneStartPage.faces?chco=y" },
                    { name: "OPAL", url: "https://bildungsportal.sachsen.de/opal/home/?5&ajax=true" },
                    { name: "TUC Mail", url: "https://mail.tu-chemnitz.de/SOGo/" },
                    { name: "TUC Cloud", url: "https://tuc.cloud/index.php/apps/files/files" },
                    { name: "TUC Overleaf", url: "https://overleaf.hrz.tu-chemnitz.de/project" },
                    { name: "Speiseplan", url: "https://www.swcz.de/bilderspeiseplan/" },
                    { name: "swcz.de", url: "https://www.swcz.de/" },
                    { name: "CSN", url: "https://www.csn.tu-chemnitz.de/secure/user/" },
                    { name: "Deutschlandsemesterticket", url: "https://abo.ride-ticketing.de/app/subscription?partnerId=35e9b2855e1721fd6cb06488eb05ef80&bookingId=e24f7f9995f3ffe564ebc09304f7700b" }
                ]
            },
            {
                category: "AI Tools",
                links: [
                    { name: "SciMaster", url: "https://scimaster.bohrium.com/chat/" },
                    { name: "Gemini", url: "https://gemini.google.com/app" },
                    { name: "NotebookLM", url: "https://notebooklm.google.com/" },
                    { name: "Perplexity", url: "https://perplexity.ai" },
                    { name: "DeepSeek", url: "https://chat.deepseek.com/" },
                    { name: "Wuaicha", url: "https://wuaicha.com/#/dashboard" },
                    { name: "ChatGPT", url: "https://chatgpt.com/" },
                    { name: "Grok", url: "https://grok.com/" },
                    { name: "Hugging Face", url: "https://huggingface.co" },
                    { name: "Matbench Discovery", url: "https://matbench-discovery.materialsproject.org/" },
                    { name: "Mistral", url: "https://chat.mistral.ai/chat" },
                    { name: "Claude AI", url: "https://claude.ai/new" },
                    { name: "Ollama", url: "https://ollama.com/" },
                    { name: "Google AI Studio", url: "https://aistudio.google.com/prompts/new_chat" },
                    { name: "LM Studio", url: "https://lmstudio.ai/" },
                    { name: "Tongyi", url: "https://www.tongyi.com/" }
                ]
            },
            {
                category: "Computation Tools",
                links: [
                    { name: "Abinit", url: "https://www.abinit.org/" },
                    { name: "Abinit variables", url: "https://docs.abinit.org/variables/#A" },
                    { name: "Abipy Book", url: "https://abinit.github.io/abipy_book/intro.html" },
                    { name: "Pseudo-dojo", url: "https://www.pseudo-dojo.org/" },
                    { name: "DFTB+", url: "https://dftbplus.org/index.html#" },
                    { name: "PubChem", url: "https://pubchem.ncbi.nlm.nih.gov/" },
                    { name: "Materials Project", url: "https://next-gen.materialsproject.org/" },
                    { name: "ORCA", url: "https://orcaforum.kofo.mpg.de/app.php/portal" },
                    { name: "VESTA", url: "https://jp-minerals.org/vesta/en/" }
                ]
            },
            {
                category: "Organization",
                links: [
                    { name: "DFG", url: "https://www.dfg.de/en" },
                    { name: "DPG", url: "https://www.dpg-physik.de/" },
                    { name: "Psi-k", url: "https://psi-k.net/" },
                    { name: "NHR Training", url: "https://tu-dresden.de/zih/hochleistungsrechnen/nhr-training" },
                    { name: "HLRS", url: "https://www.hlrs.de/" },
                    { name: "LRZ", url: "https://www.lrz.de/en/" },
                    { name: "JSC Training", url: "https://www.fz-juelich.de/en/ias/jsc/education/training-courses/course-calendar" },
                    { name: "ASC Training", url: "https://asc.ac.at/training/" },
                    { name: "ScaDS.AI", url: "https://scads.ai/transfer/teaching-and-training/" }
                ]
            },
            {
                category: "German Learning",
                links: [
                    { name: "Google Translate", url: "https://translate.google.com/" },
                    { name: "Godic", url: "https://www.godic.net/" },
                    { name: "ARD Mediathek", url: "https://www.ardmediathek.de/" },
                    { name: "ZDF", url: "https://www.zdf.de/" },
                    { name: "Goethe-Institut", url: "https://www.goethe.de/de/index.html" },
                    { name: "Schubert-Verlag", url: "https://www.schubert-verlag.de/index.php" },
                    { name: "Nachrichtenleicht", url: "https://www.nachrichtenleicht.de/" },
                    { name: "Klett Sprachen", url: "https://www.klett-sprachen.de/" },
                    { name: "tagesschau", url: "https://www.tagesschau.de" },
                    { name: "MDR Nachrichten", url: "https://www.mdr.de/nachrichten/index.html" },
                    { name: "Das Erste", url: "https://www.daserste.de" },
                    { name: "ARD", url: "https://www.ard.de" },
                    { name: "MDR", url: "https://www.mdr.de" },
                    { name: "NDR", url: "https://www.ndr.de" },
                    { name: "WDR", url: "https://www.wdr.de" },
                    { name: "BR", url: "https://www.br.de" },
                    { name: "SWR", url: "https://www.swr.de" },
                    { name: "RBB", url: "https://www.rbb-online.de" },
                    { name: "HR", url: "https://www.hr.de" },
                    { name: "SR", url: "https://www.sr.de" },
                    { name: "Radio Bremen", url: "https://www.radiobremen.de" },
                    { name: "Arte", url: "https://www.arte.tv/de/" },
                    { name: "3sat", url: "https://www.3sat.de" },
                    { name: "KiKA", url: "https://www.kika.de" },
                    { name: "Phoenix", url: "https://www.phoenix.de" }
                ]
            },
            {
                category: "Travel",
                links: [
                    { name: "Google Maps", url: "https://www.google.com/maps" },
                    { name: "Booking.com", url: "https://www.booking.com/" },
                    { name: "Deutsche Bahn", url: "https://int.bahn.de/en" },
                    { name: "FlixBus", url: "https://global.flixbus.com/" },
                    { name: "Ctrip", url: "https://ctrip.com/" },
                    { name: "Skyscanner", url: "https://www.skyscanner.de/" },
                    { name: "Omio", url: "https://www.omio.com/" },
                    { name: "Airbnb", url: "https://www.airbnb.de/" },
                    { name: "Kiwi.com", url: "https://www.kiwi.com/de/" },
                    { name: "SBB", url: "https://www.sbb.ch/de" },
                    { name: "Trenitalia", url: "https://www.trenitalia.com/en.html" }
                ]
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                container: document.getElementById('categoriesContainer'),
                searchInput: document.getElementById('searchInput'),
                suggestionsContainer: document.getElementById('searchSuggestions'),
                overlay: document.getElementById('global-overlay'),
                footerText: document.querySelector('footer p:first-of-type')
            };

            let currentlyExpandedCard = null;

            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            function renderCategories() {
                let totalLinks = 0;
                elements.container.innerHTML = siteData.map(category => {
                    totalLinks += category.links.length;
                    const hasMoreItems = category.links.length > 5;
                    return `
                        <div class="category-card" data-state="collapsed" data-total-links="${category.links.length}" data-category-name="${category.category}">
                            <h2 class="category-title">${category.category}</h2>
                            <ul class="link-list">
                                ${category.links.map((link, index) => `
                                    <li class="link-item ${index >= 5 ? 'hidden' : ''}" data-index="${index}">
                                        <a href="${link.url}" target="_blank">${link.name}</a>
                                    </li>`).join('')}
                            </ul>
                            ${hasMoreItems ? '<button class="more-indicator">more</button>' : ''}
                        </div>`;
                }).join('');
                elements.footerText.textContent = `¬© ${new Date().getFullYear()} Smart Navigation - ${totalLinks} quality websites collected`;
            }

            function handleSearch(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.body.classList.toggle('is-searching', searchTerm.length > 0);

                document.querySelectorAll('.category-card').forEach(card => {
                    if (searchTerm.length === 0) {
                        card.classList.remove('hidden-by-search');
                        card.querySelectorAll('.link-item').forEach(link => link.classList.remove('hidden'));
                        return;
                    }

                    let visibleCount = 0;
                    card.querySelectorAll('.link-item').forEach(link => {
                        const match = link.querySelector('a').textContent.toLowerCase().includes(searchTerm);
                        link.classList.toggle('hidden', !match);
                        if (match) visibleCount++;
                    });
                    card.classList.toggle('hidden-by-search', visibleCount === 0);
                });
            }
            
            function expandCard(card) {
                if (currentlyExpandedCard && currentlyExpandedCard !== card) {
                    collapseCard(currentlyExpandedCard);
                }
                
                // Store the original position and dimensions
                const cardRect = card.getBoundingClientRect();
                const originalWidth = cardRect.width;
                const originalHeight = cardRect.height;
                
                // Create a perfect placeholder with exact same dimensions and content
                const placeholder = card.cloneNode(true);
                placeholder.className = 'category-card-placeholder';
                placeholder.style.width = `${originalWidth}px`;
                placeholder.style.height = `${originalHeight}px`;
                placeholder.style.minHeight = `${originalHeight}px`;
                placeholder.style.maxHeight = `${originalHeight}px`;
                
                // Remove any expanded state from placeholder
                placeholder.dataset.state = 'collapsed';
                placeholder.classList.remove('expand-left');
                
                // Insert placeholder right before the original card
                card.parentNode.insertBefore(placeholder, card);
                
                // Store reference for cleanup
                const placeholderId = Date.now().toString();
                card.dataset.placeholderId = placeholderId;
                placeholder.dataset.cardPlaceholder = placeholderId;
                
                // Set up the expanded card positioning
                card.style.setProperty('--card-top', `${cardRect.top + window.scrollY}px`);
                card.style.setProperty('--card-left', `${cardRect.left}px`);
                card.style.setProperty('--original-width', `${originalWidth}px`);
                
                currentlyExpandedCard = card;
                card.dataset.state = 'expanded';
                document.body.classList.add('is-card-expanded');
                elements.overlay.classList.remove('hidden');

                const totalLinks = parseInt(card.dataset.totalLinks);
                const maxPerColumn = 15;

                // Only calculate overflow and use multi-column on wider screens
                if (window.innerWidth > 768) {
                    const { needsLeftExpansion, expectedWidth } = checkIfCardWillOverflow(card);
                    card.style.setProperty('--expanded-width', `${expectedWidth}px`);
                    card.classList.toggle('expand-left', needsLeftExpansion);

                    if (totalLinks > maxPerColumn) {
                        createMultiColumnLayout(card, maxPerColumn);
                    }
                } else {
                    // On narrow screens, use single column and full width
                    card.style.removeProperty('--expanded-width');
                    card.classList.remove('expand-left');
                    if (totalLinks > maxPerColumn) {
                        createMultiColumnLayout(card, maxPerColumn); // This will create single column due to screen width check
                    }
                }

                card.querySelectorAll('.link-item.hidden').forEach(link => link.classList.remove('hidden'));
            }

            function collapseCard(card) {
                if (!card) return;
                
                // Check if this was a single column expansion
                const linkList = card.querySelector('.link-list');
                const isSingleColumn = !linkList.classList.contains('multi-column');
                
                // Temporarily disable transitions on all cards to prevent unwanted animations
                document.body.classList.add('disable-card-transitions');
                
                const placeholderId = card.dataset.placeholderId;
                let placeholder = null;
                if (placeholderId) {
                    placeholder = document.querySelector(`[data-card-placeholder="${placeholderId}"]`);
                }
                
                // Change the card state
                card.dataset.state = 'collapsed';
                card.classList.remove('expand-left');
                card.style.removeProperty('--expanded-width');
                
                // Reset the card content
                if (linkList.classList.contains('multi-column')) {
                    const allLinks = Array.from(linkList.querySelectorAll('.link-item'));
                    linkList.innerHTML = '';
                    allLinks.sort((a, b) => a.dataset.index - b.dataset.index).forEach(link => linkList.appendChild(link));
                    linkList.classList.remove('multi-column');
                }

                card.querySelectorAll('.link-item').forEach((link, index) => {
                    if (index >= 5) link.classList.add('hidden');
                });

                if (currentlyExpandedCard === card) {
                    currentlyExpandedCard = null;
                    document.body.classList.remove('is-card-expanded');
                    elements.overlay.classList.add('hidden');
                }
                
                if (isSingleColumn) {
                    // For single column: Never remove placeholder, just let card cover it
                    card.style.removeProperty('--card-top');
                    card.style.removeProperty('--card-left');
                    card.style.removeProperty('--original-width');
                    
                    // Hide placeholder but don't remove it to maintain grid space
                    if (placeholder) {
                        placeholder.style.display = 'none';
                        placeholder.style.visibility = 'hidden';
                    }
                    
                    // Re-enable transitions after extended delay
                    setTimeout(() => {
                        document.body.classList.remove('disable-card-transitions');
                        
                        // Only remove placeholder much later, when user is likely not watching
                        setTimeout(() => {
                            if (placeholder && placeholder.parentNode) {
                                placeholder.remove();
                            }
                            if (placeholderId) {
                                delete card.dataset.placeholderId;
                            }
                        }, 2000); // Very long delay
                    }, 300);
                } else {
                    // For multi-column: Use atomic operation with requestAnimationFrame
                    requestAnimationFrame(() => {
                        card.style.removeProperty('--card-top');
                        card.style.removeProperty('--card-left');
                        card.style.removeProperty('--original-width');
                        
                        if (placeholder) {
                            placeholder.remove();
                        }
                        if (placeholderId) {
                            delete card.dataset.placeholderId;
                        }
                        
                        setTimeout(() => {
                            document.body.classList.remove('disable-card-transitions');
                        }, 50);
                    });
                }
            }

            function createMultiColumnLayout(card, maxPerColumn) {
                const linkList = card.querySelector('.link-list');
                const categoryName = card.dataset.categoryName;
                const categoryData = siteData.find(cat => cat.category === categoryName);
                if (!categoryData) return;

                const totalLinks = categoryData.links.length;
                
                // Check if we should use multi-column based on screen width
                const shouldUseMultiColumn = window.innerWidth > 768 && totalLinks > maxPerColumn;
                
                linkList.innerHTML = '';
                
                if (shouldUseMultiColumn) {
                    const numColumns = Math.ceil(totalLinks / maxPerColumn);
                    linkList.classList.add('multi-column');
                    
                    for (let col = 0; col < numColumns; col++) {
                        const column = document.createElement('ul');
                        column.className = 'link-column';
                        
                        const startIndex = col * maxPerColumn;
                        const endIndex = Math.min(startIndex + maxPerColumn, totalLinks);
                        
                        for (let i = startIndex; i < endIndex; i++) {
                            const link = categoryData.links[i];
                            const linkElement = document.createElement('li');
                            linkElement.className = 'link-item';
                            linkElement.dataset.index = i;
                            
                            // Add title attribute for tooltip if text is long
                            const titleAttr = link.name.length > 20 ? ` title="${link.name}"` : '';
                            linkElement.innerHTML = `<a href="${link.url}" target="_blank"${titleAttr}>${link.name}</a>`;
                            column.appendChild(linkElement);
                        }
                        linkList.appendChild(column);
                    }
                } else {
                    // Single column layout for narrow screens or fewer links
                    linkList.classList.remove('multi-column');
                    for (let i = 0; i < totalLinks; i++) {
                        const link = categoryData.links[i];
                        const linkElement = document.createElement('li');
                        linkElement.className = 'link-item';
                        linkElement.dataset.index = i;
                        linkElement.innerHTML = `<a href="${link.url}" target="_blank">${link.name}</a>`;
                        linkList.appendChild(linkElement);
                    }
                }
            }

            function checkIfCardWillOverflow(card) {
                const cardRect = card.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const containerRect = elements.container.getBoundingClientRect();
                
                const totalLinks = parseInt(card.dataset.totalLinks);
                const maxPerColumn = 15;
                
                let expectedWidth;
                
                // On narrow screens, use single column layout
                if (viewportWidth <= 768) {
                    expectedWidth = Math.min(cardRect.width, viewportWidth - 40); // Leave some margin
                    return { needsLeftExpansion: false, expectedWidth };
                }
                
                // On wider screens, calculate multi-column width
                if (totalLinks > maxPerColumn) {
                    const numColumns = Math.ceil(totalLinks / maxPerColumn);
                    expectedWidth = numColumns * 280 + (numColumns - 1) * 32;
                } else {
                    expectedWidth = 400;
                }
                
                const rightSpace = Math.min(viewportWidth, containerRect.right) - cardRect.right - 20;
                const needsLeftExpansion = rightSpace < (expectedWidth - cardRect.width);
                
                return { needsLeftExpansion, expectedWidth };
            }

            function setupEventListeners() {
                elements.searchInput.addEventListener('input', debounce(handleSearch, 250));

                elements.container.addEventListener('click', e => {
                    const target = e.target;
                    const card = target.closest('.category-card');
                    if (!card) return;

                    if (target.closest('.category-title') || target.closest('.more-indicator')) {
                        e.preventDefault();
                        card.dataset.state === 'collapsed' ? expandCard(card) : collapseCard(card);
                    }
                });

                elements.overlay.addEventListener('click', () => collapseCard(currentlyExpandedCard));

                document.addEventListener('keydown', e => {
                    if (e.key === 'Escape' && currentlyExpandedCard) collapseCard(currentlyExpandedCard);
                    if (e.ctrlKey && e.key === 'k') {
                        e.preventDefault();
                        elements.searchInput.focus();
                    }
                });

                window.addEventListener('resize', debounce(() => {
                    if (currentlyExpandedCard) {
                        // Re-expand the card to adjust layout for new screen size
                        const card = currentlyExpandedCard;
                        const wasExpanded = card.dataset.state === 'expanded';
                        
                        if (wasExpanded) {
                            // On resize, we need to recalculate the position
                            // First collapse the card, then re-expand it to get fresh position
                            const categoryName = card.dataset.categoryName;
                            collapseCard(card);
                            
                            // Find the card again in the DOM (since it might have moved in grid)
                            setTimeout(() => {
                                const newCard = document.querySelector(`[data-category-name="${categoryName}"]`);
                                if (newCard) {
                                    expandCard(newCard);
                                }
                            }, 50);
                        }
                    }
                }, 100));
            }

            renderCategories();
            setupEventListeners();
        });
    </script>
</body>
</html>
